#!/bin/bash
# agent-shell-spawn - Spawn a new named agent
# Usage: agent-shell-spawn "AgentName" ["initial task"]
#
# Spawns agent in the calling agent's project (via PID lookup).
# Falls back to current directory if not called from an agent.
# Includes spawner identity so new agent knows who to report back to.

if [ $# -lt 1 ]; then
    echo "Usage: agent-shell-spawn \"AgentName\" [\"initial task\"]" >&2
    exit 1
fi

name="$1"
task="${2:-}"

# Get spawner identity
spawner=$(emacsclient --eval "(meta-agent-shell-whoami $$)" 2>/dev/null | tr -d '"')
if [ "$spawner" = "nil" ] || [ -z "$spawner" ]; then
    spawner="unknown"
fi

# Get project path from calling agent's buffer, fall back to pwd
project_path=$(emacsclient --eval "(meta-agent-shell-project-path $$)" 2>/dev/null | tr -d '"')
if [ "$project_path" = "nil" ] || [ -z "$project_path" ]; then
    project_path="$(pwd)"
fi

# Format initial message with spawner info
if [ -n "$task" ]; then
    initial_message="Spawned by: $spawner

Task: $task"
    emacsclient --eval "(meta-agent-shell-start-named-agent \"$project_path\" \"$name\" \"$initial_message\")"
else
    emacsclient --eval "(meta-agent-shell-start-named-agent \"$project_path\" \"$name\")"
fi
