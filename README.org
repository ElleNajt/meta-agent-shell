#+TITLE: meta-agent-shell
#+AUTHOR: Elle Najt

Multi-agent coordination for [[https://github.com/xenodium/agent-shell][agent-shell]].

[[file:docs/cli-tools.png]]

* What This Does

Two levels of coordination:

1. *Project Dispatchers* - coordinate multiple agents within a single project
2. *Meta-Agent* - oversees all your projects, receives status heartbeats, monitors everything

Plus:
- *Inter-agent communication* via CLI tools (~agent-send~, ~agent-ask~, ~agent-search~)
- *Task tracking* in org files that show up in your Emacs agenda
- *ICC logging* - all agent-to-agent messages logged as JSONL
- *Big red button* - ~M-x meta-agent-shell-big-red-button~ stops everything

* Setup

#+begin_src bash
./setup.sh
#+end_src

This:
1. Creates =~/.claude-meta/= directory
2. Links the meta-agent CLAUDE.md
3. Tells you what to add to your shell config and =~/.claude/CLAUDE.md=

Then add to your Emacs config:

#+begin_src elisp
(use-package meta-agent-shell
  :after agent-shell
  :config
  (setq meta-agent-shell-heartbeat-file "~/heartbeat.org")
  (setq meta-agent-shell-start-function #'agent-shell)  ; or your custom start function

  ;; Recommended keybindings under SPC o m
  ;; Unbind existing SPC o m (mu4e in Doom) first if needed
  (define-key doom-leader-map "om" nil)
  (map! :leader
        (:prefix ("o m" . "meta-agent")
         :desc "Meta-agent session" "m" #'meta-agent-shell-start
         :desc "Project dispatcher" "d" #'meta-agent-shell-jump-to-dispatcher
         :desc "Start heartbeat" "h" #'meta-agent-shell-heartbeat-start
         :desc "Stop heartbeat" "H" #'meta-agent-shell-heartbeat-stop
         :desc "Send heartbeat now" "s" #'meta-agent-shell-heartbeat-send-now
         :desc "STOP ALL AGENTS" "!" #'meta-agent-shell-big-red-button)))
#+end_src

| Keybinding  | Command                              | Description                     |
|-------------+--------------------------------------+---------------------------------|
| =SPC o m m= | ~meta-agent-shell-start~             | Meta-agent session (start/switch) |
| =SPC o m d= | ~meta-agent-shell-jump-to-dispatcher~ | Project dispatcher (start/switch) |
| =SPC o m h= | ~meta-agent-shell-heartbeat-start~   | Start heartbeat timer           |
| =SPC o m H= | ~meta-agent-shell-heartbeat-stop~    | Stop heartbeat timer            |
| =SPC o m s= | ~meta-agent-shell-heartbeat-send-now~ | Send heartbeat immediately      |
| =SPC o m != | ~meta-agent-shell-big-red-button~    | STOP ALL AGENTS                 |

* Workflow 1: Project Dispatchers

Use dispatchers when you want multiple agents working on a single project.

** Start a dispatcher

#+begin_example
M-x meta-agent-shell-start-dispatcher
#+end_example

The dispatcher runs in your project directory and can spawn agents, assign tasks, and coordinate work.

** Jump to dispatcher

#+begin_example
M-x meta-agent-shell-jump-to-dispatcher
#+end_example

Jumps to the dispatcher for the current buffer's project. If none exists, offers to create one.

** CLI tools for agents

Agents communicate with each other using these shell commands:

#+begin_src bash
agent-spawn "AgentName" "initial task"  # spawn a new named agent
agent-send "buffer-name" "message"
agent-ask "buffer-name" "question"      # reply routed back automatically
agent-whoami                            # print own buffer name
agent-search "pattern"                  # search all sessions for regexp
agent-search "pattern" projectname      # search specific project
#+end_src

Agents are taught these tools via =agent-overview.md= (included in setup).

** How agent identity works

The CLI tools pass the shell's PID (~$$~), and the system walks up the process tree to find the ACP client:

#+begin_example
$$ (shell) → zsh → claude → node (ACP client)
#+end_example

Each agent-shell buffer owns an ACP client process. Match the PID, find the buffer. So agents identify themselves without knowing their buffer name.

** Task tracking

Dispatchers can write tasks to =.tasks/current.org= in the project:

#+begin_src org
** TODO Refactor auth middleware :@claude:
   :PROPERTIES:
   :ASSIGNED: Refactor
   :END:
#+end_src

Add =.tasks/= to your =org-agenda-files= and tasks show up in your agenda.

* Workflow 2: Meta-Agent

Use the meta-agent when you want oversight across multiple projects.

** Start the meta-agent

#+begin_example
M-x meta-agent-shell-start
#+end_example

This starts a dedicated agent in =~/.claude-meta/= that can see all your active sessions.

** Heartbeat

The meta-agent receives periodic heartbeats with status updates from all your projects.

*** Setup

1. Create a file with standing instructions:

#+begin_src bash
echo "Check on agent progress. Alert me if any seem stuck." > ~/heartbeat.org
#+end_src

2. Configure:

#+begin_src elisp
(setq meta-agent-shell-heartbeat-file "~/heartbeat.org")
(setq meta-agent-shell-heartbeat-interval 900)  ; seconds between heartbeats (default 15 min)
(setq meta-agent-shell-heartbeat-cooldown 300)  ; delay after you message the meta-agent
#+end_src

3. Start:

#+begin_example
M-x meta-agent-shell-heartbeat-start
#+end_example

*** What it sends

Each heartbeat includes:
- List of all active sessions with status (working/idle)
- Recent output from watched projects (if configured)
- Your standing instructions from the heartbeat file

*** Other commands

- ~M-x meta-agent-shell-heartbeat-stop~ - stop the timer
- ~M-x meta-agent-shell-heartbeat-send-now~ - send one immediately

* Logging

All inter-agent messages logged to =~/.meta-agent-shell/logs/YYYY-MM-DD-icc.jsonl=:

#+begin_src json
{"timestamp":"2026-02-05T14:32:01","type":"ask","from":"(proj)-A","to":"(proj)-B","message":"..."}
#+end_src

* Sandboxed Workflow (WIP)

See [[file:docs/sandboxing.org][docs/sandboxing.org]] for running workers in containers with restricted dispatcher permissions.

Note: Still needs a tunnel from containerized agents back to the host dispatcher.

* License

GPL-3.0
